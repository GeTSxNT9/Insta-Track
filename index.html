<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
<title>INSTA TRACK ALPHA</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="icon" href="https://api.dicebear.com/7.x/initials/svg?seed=I&backgroundColor=000000&textColor=ffffff&fontSize=60&fontWeight=700">
<link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/initials/svg?seed=I&backgroundColor=000000&textColor=ffffff&fontSize=60&fontWeight=700">

<style>
  :root {
    --bg: #f0f2f5; --card: #ffffff; --border: #dce2e8; --accent: #0095f6;
    --success: #00ba69; --text: #1c1e21; --muted: #65676b; --radius: 16px;
    --danger: #f4212e;
  }
  
  body { background: var(--bg); margin:0; padding:10px; display:flex; justify-content:center; color: var(--text); font-family: -apple-system, system-ui, sans-serif; }
  .container { max-width: 1000px; width: 100%; background: var(--card); border-radius: var(--radius); padding:20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-top: 10px; }
  
  header { text-align: center; margin-bottom: 25px; }
  h1 { margin: 0; font-size: 22px; letter-spacing: -0.5px; font-weight: 800; }
  .version-tag { font-size: 10px; background: #e4e6eb; padding: 2px 8px; border-radius: 4px; vertical-align: middle; color: var(--muted); text-transform: uppercase; }

  .grid-upload { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:15px; margin-bottom: 25px; }
  .file-box { background: #f7f8fa; padding: 15px; border-radius: var(--radius); border: 2px dashed var(--border); transition: 0.2s; position: relative; text-align: center; }
  .file-box label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 12px; color: var(--muted); text-transform: uppercase; }
  .file-box input { font-size: 12px; width: 100%; }
  .file-box.loaded { border-color: var(--success); background: #f0fdf4; border-style: solid; }
  
  .main-actions { display:flex; gap:10px; margin-bottom: 30px; flex-wrap: wrap; }
  button { padding:12px 18px; border-radius:12px; border:none; cursor:pointer; font-weight:600; font-size: 14px; transition: 0.2s; display: flex; align-items: center; gap: 8px; justify-content: center; }
  .btn-primary { background: var(--accent); color:#fff; flex: 2; min-width: 150px; }
  .btn-outline { background: #fff; border: 1px solid var(--border); color: var(--text); flex: 1; }
  .btn-danger { background: #fff1f2; color: var(--danger); flex: 1; }

  .stats-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; margin-bottom: 25px; }
  .stat-card { background: #fff; padding:15px; border-radius:var(--radius); text-align:center; border: 1px solid var(--border); }
  .stat-card span { font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 700; display: block; margin-bottom: 5px; }
  .stat-card strong { font-size: 24px; color: var(--text); }
  
  .grid-lists { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px; }
  .column-title { margin-bottom: 12px; font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 8px; }
  
  .search-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border); border-radius: 12px; font-size: 14px; box-sizing: border-box; outline: none; transition: 0.2s; }
  .search-input:focus { border-color: var(--accent); }
  
  .scroll-area { height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius); padding: 8px; background: #fafafa; scrollbar-width: thin; }
  
  .user-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; animation: fadeIn 0.3s ease; }
  .user-tag { flex-grow: 1; padding: 10px 14px; background: #fff; color: var(--text); text-decoration: none; border-radius: 12px; font-size: 13px; border: 1px solid var(--border); transition: 0.15s; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .user-tag:hover { border-color: var(--accent); background: #f0f9ff; }
  
  .btn-ghost { padding: 10px; background: #fff; color: #adb5bd; border: 1px solid var(--border); border-radius: 10px; cursor: pointer; line-height: 1; }
  .btn-ghost:hover { color: var(--danger); border-color: var(--danger); background: #fff1f2; }
  
  textarea { width:100%; height:120px; padding:12px; border-radius:12px; border: 1px solid var(--border); font-family: 'Courier New', monospace; font-size: 12px; margin-bottom: 10px; box-sizing: border-box; resize: none; outline: none; }
  .hidden { display:none !important; }
  .panel-ghost { margin-bottom: 25px; padding: 18px; background: #fff; border: 1px solid var(--border); border-radius: var(--radius); border-left: 4px solid var(--danger); }

  #saveIndicator { position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; display: none; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
  @media (max-width: 600px) { .stats-grid { grid-template-columns: 1fr 1fr; } .main-actions button { flex: unset; width: 100%; } }
</style>
</head>
<body>

<div id="saveIndicator">Guardado ‚úì</div>

<div class="container">
  <header>
    <h1>INSTA TRACK <span class="version-tag">Alpha v1.2</span></h1>
  </header>
  
  <div class="grid-upload">
    <div class="file-box" id="boxFollowing">
      <label>Sigo a... (Following)</label>
      <input id="fileFollowing" type="file" onchange="markLoaded('boxFollowing')" accept=".json,.html">
    </div>
    <div class="file-box" id="boxFollowers">
      <label>Me siguen... (Followers)</label>
      <input id="fileFollowers" type="file" onchange="markLoaded('boxFollowers')" accept=".json,.html">
    </div>
  </div>

  <div class="main-actions">
    <button id="processBtn" class="btn-primary">üìä ANALIZAR AHORA</button>
    <button onclick="location.reload()" class="btn-outline">üßπ LIMPIAR</button>
    <button onclick="toggleGhost()" class="btn-danger">üëª FILTROS</button>
  </div>

  <div id="ghostManager" class="panel-ghost hidden">
    <h3 style="margin-top:0; font-size: 15px; color: var(--danger);">Gesti√≥n de Excepciones (Whitelist)</h3>
    <p style="font-size: 11px; color: var(--muted); margin-top: -10px; margin-bottom: 10px;">Los usuarios aqu√≠ listados no aparecer√°n en "No me siguen".</p>
    <textarea id="ghostList" oninput="saveGhosts()" placeholder="Ejemplo:
cristiano
leomessi
nasa"></textarea>
    <div style="display:flex; gap:10px;">
      <button onclick="downloadGhosts()" class="btn-outline" style="font-size:11px; flex: 1;">üì• Exportar TXT</button>
      <label class="btn-outline" style="font-size:11px; padding: 10px; cursor: pointer; flex: 1; text-align: center;">
        üì§ Importar TXT <input type="file" style="display:none" accept=".txt" onchange="importGhosts(this)">
      </label>
    </div>
  </div>

  <div class="results hidden" id="results">
    <div class="stats-grid">
      <div class="stat-card"><span>Sigo</span><strong id="countFollowing">0</strong></div>
      <div class="stat-card"><span>Seguidores</span><strong id="countFollowers">0</strong></div>
      <div class="stat-card" style="background: #fff1f2;"><span>No me siguen</span><strong id="countNotFollowing" style="color: var(--danger);">0</strong></div>
      <div class="stat-card" style="background: #f0fdf4;"><span>No los sigo</span><strong id="countIShouldFollow" style="color: var(--success);">0</strong></div>
    </div>

    <div class="grid-lists">
      <div>
        <div class="column-title">üö´ No me siguen</div>
        <input type="text" class="search-input" placeholder="Filtrar por nombre..." onkeyup="filterList('notFollowingLinks', this.value)">
        <div id="notFollowingLinks" class="scroll-area"></div>
      </div>
      
      <div>
        <div class="column-title">ü§ù Seguimiento mutuo</div>
        <button onclick="copyToClipboard('mutuals')" class="btn-outline" style="width:100%; margin-bottom:10px; font-size: 12px;">üìã Copiar nombres de usuarios</button>
        <textarea id="mutuals" readonly style="height:398px; background:#f8f9fa; color: var(--muted);"></textarea>
      </div>
      
      <div>
        <div class="column-title">‚≠ê Fans (No los sigo)</div>
        <input type="text" class="search-input" placeholder="Filtrar por nombre..." onkeyup="filterList('iShouldFollowLinks', this.value)">
        <div id="iShouldFollowLinks" class="scroll-area"></div>
      </div>
    </div>
  </div>
</div>

<script>
// Service Worker Registration con detecci√≥n de ruta
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    const swPath = window.location.pathname.includes('/Insta-Track/') ? '/Insta-Track/sw.js' : 'sw.js';
    navigator.serviceWorker.register(swPath).then(reg => {
      console.log('SW activo en:', reg.scope);
    }).catch(err => console.log('Error SW:', err));
  });
}

window.onload = () => {
  const saved = localStorage.getItem('insta_ghost_list');
  if (saved) document.getElementById('ghostList').value = saved;
};

function saveGhosts() { 
  localStorage.setItem('insta_ghost_list', document.getElementById('ghostList').value); 
  showIndicator();
}

function showIndicator() {
  const ind = document.getElementById('saveIndicator');
  ind.style.display = 'block';
  clearTimeout(window.saveTimer);
  window.saveTimer = setTimeout(() => ind.style.display = 'none', 1500);
}

function toggleGhost() { document.getElementById('ghostManager').classList.toggle('hidden'); }
function markLoaded(id) { document.getElementById(id).classList.add('loaded'); }

function filterList(containerId, query) {
  const items = document.getElementById(containerId).getElementsByClassName('user-row');
  const q = query.toLowerCase();
  for (let item of items) {
    item.style.display = item.textContent.toLowerCase().includes(q) ? 'flex' : 'none';
  }
}

async function extract(file) {
  const text = await file.text();
  const found = new Set();
  // Regex mejorado para capturar usuarios en JSON (value/string) y HTML (links)
  const regex = /(?:(?<=>)|(?<="value":\s*")|(?<=\/_u\/)|(?<=\.com\/))([a-z0-9._]{2,30})(?=[<"]|\/|$)/gi;
  const userGhosts = document.getElementById('ghostList').value.toLowerCase().split('\n').map(s => s.trim()).filter(s => s);
  const blacklist = ['_u', 'u', 'siguiendo', 'seguidores', 'mensaje', 'explore', 'reels', 'true', 'false', 'direct', ...userGhosts];
  
  let m;
  while ((m = regex.exec(text)) !== null) {
    const user = m[1].toLowerCase();
    if (!blacklist.includes(user) && !/^\d+$/.test(user) && user.length > 2) {
      found.add(user);
    }
  }
  return Array.from(found);
}

document.getElementById('processBtn').onclick = async () => {
  const f1 = document.getElementById('fileFollowing').files[0];
  const f2 = document.getElementById('fileFollowers').files[0];
  if (!f1 || !f2) return alert("Por favor, selecciona ambos archivos (Following y Followers).");

  document.getElementById('processBtn').textContent = "üîÑ Procesando...";
  
  try {
    const following = await extract(f1);
    const followers = await extract(f2);
    const setFollowing = new Set(following);
    const setFollowers = new Set(followers);

    renderList('notFollowingLinks', following.filter(u => !setFollowers.has(u)).sort());
    renderList('iShouldFollowLinks', followers.filter(u => !setFollowing.has(u)).sort());
    
    document.getElementById('mutuals').value = following.filter(u => setFollowers.has(u)).sort().join('\n');
    document.getElementById('countFollowing').textContent = following.length;
    document.getElementById('countFollowers').textContent = followers.length;
    document.getElementById('countNotFollowing').textContent = following.filter(u => !setFollowers.has(u)).length;
    document.getElementById('countIShouldFollow').textContent = followers.filter(u => !setFollowing.has(u)).length;
    
    document.getElementById('results').classList.remove('hidden');
    document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
  } catch (err) {
    alert("Error procesando los archivos. Aseg√∫rate de usar los archivos exportados de Instagram.");
  } finally {
    document.getElementById('processBtn').textContent = "üìä ANALIZAR AHORA";
  }
};

function renderList(id, users) {
  const container = document.getElementById(id);
  container.innerHTML = '';
  users.forEach((u, index) => {
    const itemId = `row-${id}-${index}`;
    const div = document.createElement('div');
    div.className = 'user-row';
    div.id = itemId;
    div.innerHTML = `
      <a href="https://www.instagram.com/${u}/" target="_blank" class="user-tag">@${u}</a>
      <button class="btn-ghost" onclick="addToGhost('${u}', '${itemId}')" title="A√±adir a excepciones">üëª</button>
    `;
    container.appendChild(div);
  });
}

function addToGhost(user, elementId) {
  let list = document.getElementById('ghostList');
  const currentVal = list.value.trim();
  list.value = currentVal + (currentVal ? '\n' : '') + user;
  saveGhosts();
  
  const el = document.getElementById(elementId);
  el.style.opacity = '0';
  setTimeout(() => el.style.display = 'none', 300);
  
  // Actualizar contador si es la lista de "No me siguen"
  if (elementId.includes('notFollowingLinks')) {
    let counter = document.getElementById('countNotFollowing');
    counter.textContent = Math.max(0, parseInt(counter.textContent) - 1);
  }
}

function copyToClipboard(id) {
  const area = document.getElementById(id);
  area.select();
  navigator.clipboard.writeText(area.value);
  alert("¬°Lista de mutuos copiada al portapapeles!");
}

function downloadGhosts() {
  const blob = new Blob([document.getElementById('ghostList').value], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'whitelist_instatrack.txt';
  a.click();
}

async function importGhosts(input) {
  if (!input.files[0]) return;
  const content = await input.files[0].text();
  document.getElementById('ghostList').value = content;
  saveGhosts();
  alert("Lista de excepciones importada con √©xito.");
}
</script>
</body>
</html>
