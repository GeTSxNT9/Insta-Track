<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>INSTA TRACK ALPHA</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="icon" href="https://api.dicebear.com/7.x/initials/svg?seed=I&backgroundColor=000000&textColor=ffffff&fontSize=60&fontWeight=700">
<link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/initials/svg?seed=I&backgroundColor=000000&textColor=ffffff&fontSize=60&fontWeight=700">

<style>
  :root {
    --bg: #f0f2f5; --card: #ffffff; --border: #dce2e8; --accent: #0095f6;
    --success: #00ba69; --text: #1c1e21; --muted: #65676b; --radius: 16px;
    --danger: #f4212e;
  }
  
  body { background: var(--bg); margin:0; padding:15px; display:flex; justify-content:center; color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
  .container { max-width: 1200px; width: 100%; background: var(--card); border-radius: var(--radius); padding:30px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  
  header { text-align: center; margin-bottom: 30px; }
  h1 { margin: 0; font-size: 24px; letter-spacing: -0.5px; }
  .version-tag { font-size: 12px; background: #e4e6eb; padding: 2px 8px; border-radius: 4px; vertical-align: middle; color: var(--muted); }

  .grid-upload { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:20px; margin-bottom: 30px; }
  .file-box { background: #f7f8fa; padding: 20px; border-radius: var(--radius); border: 2px dashed var(--border); transition: 0.2s; position: relative; }
  .file-box label { display: block; margin-bottom: 10px; font-weight: 700; font-size: 13px; color: var(--muted); }
  .file-box.loaded { border-color: var(--success); background: #f0fdf4; border-style: solid; }
  
  .main-actions { display:flex; gap:12px; margin-bottom: 35px; flex-wrap: wrap; }
  button { padding:10px 20px; border-radius:10px; border:none; cursor:pointer; font-weight:600; font-size: 14px; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
  .btn-primary { background: var(--accent); color:#fff; }
  .btn-outline { background: #fff; border: 1px solid var(--border); color: var(--text); }
  .btn-danger { background: #fff1f2; color: var(--danger); }

  .stats-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom: 30px; }
  .stat-card { background: #fff; padding:18px; border-radius:var(--radius); text-align:center; border:1px solid var(--border); }
  .stat-card span { font-size: 11px; color: var(--muted); text-transform: uppercase; font-weight: 700; }
  .stat-card strong { display: block; font-size: 28px; color: var(--text); margin-top: 5px; }
  
  .grid-lists { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:25px; }
  .column-title { margin-bottom: 15px; font-weight: 700; font-size: 16px; }
  
  .search-input { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 14px; box-sizing: border-box; }
  .scroll-area { height: 450px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius); padding: 10px; background: #fafafa; }
  
  .user-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .user-tag { flex-grow: 1; padding: 10px 14px; background: #fff; color: var(--text); text-decoration: none; border-radius: 10px; font-size: 13px; border: 1px solid var(--border); transition: 0.15s; font-weight: 500; }
  .user-tag:hover { border-color: var(--accent); color: var(--accent); }
  
  .btn-ghost { padding: 8px; background: #fff; color: #ccd0d5; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; }
  .btn-ghost:hover { color: var(--danger); border-color: var(--danger); background: #fff1f2; }
  
  textarea { width:100%; height:120px; padding:12px; border-radius:12px; border: 1px solid var(--border); font-family: monospace; font-size: 12px; margin-bottom: 10px; box-sizing: border-box; resize: none; }
  .hidden { display:none; }
  .panel-ghost { margin-bottom: 30px; padding: 20px; background: #fff; border: 1px solid var(--border); border-radius: var(--radius); }

  @media (max-width: 600px) {
    .main-actions button { width: 100%; }
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>INSTA TRACK <span class="version-tag">Alpha v1.1</span></h1>
  </header>
  
  <div class="grid-upload">
    <div class="file-box" id="boxFollowing">
      <label>SIGUIENDO (Following)</label>
      <input id="fileFollowing" type="file" onchange="markLoaded('boxFollowing')" />
    </div>
    <div class="file-box" id="boxFollowers">
      <label>SEGUIDORES (Followers)</label>
      <input id="fileFollowers" type="file" onchange="markLoaded('boxFollowers')" />
    </div>
  </div>

  <div class="main-actions">
    <button id="processBtn" class="btn-primary">üìä Analizar Datos</button>
    <button onclick="location.reload()" class="btn-outline">üßπ Reiniciar</button>
    <button onclick="toggleGhost()" class="btn-danger">üëª Gestionar Filtros</button>
  </div>

  <div id="ghostManager" class="panel-ghost hidden">
    <h3 style="margin-top:0; font-size: 16px;">Configuraci√≥n de Filtros (Fantasmas)</h3>
    <textarea id="ghostList" oninput="saveGhosts()" placeholder="Escribe un usuario por l√≠nea..."></textarea>
    <div style="display:flex; gap:10px;">
      <button onclick="downloadGhosts()" class="btn-outline" style="font-size:12px;">üì• Exportar .txt</button>
      <label class="btn-outline" style="font-size:12px; padding: 10px 20px; cursor: pointer;">
        üì§ Importar .txt <input type="file" style="display:none" accept=".txt" onchange="importGhosts(this)">
      </label>
    </div>
  </div>

  <div class="results hidden" id="results">
    <div class="stats-grid">
      <div class="stat-card"><span>Sigo</span><strong id="countFollowing">0</strong></div>
      <div class="stat-card"><span>Seguidores</span><strong id="countFollowers">0</strong></div>
      <div class="stat-card" style="border-top: 3px solid var(--danger);"><span>No me siguen</span><strong id="countNotFollowing">0</strong></div>
      <div class="stat-card" style="border-top: 3px solid var(--success);"><span>No los sigo</span><strong id="countIShouldFollow">0</strong></div>
    </div>

    <div class="grid-lists">
      <div>
        <div class="column-title">üö´ No me siguen</div>
        <input type="text" class="search-input" placeholder="Buscar usuario..." onkeyup="filterList('notFollowingLinks', this.value)">
        <div id="notFollowingLinks" class="scroll-area"></div>
      </div>
      
      <div>
        <div class="column-title">ü§ù Mutuos (Texto)</div>
        <button onclick="copyToClipboard('mutuals')" class="btn-outline" style="width:100%; margin-bottom:12px; justify-content:center;">üìã Copiar Lista</button>
        <textarea id="mutuals" readonly style="height:448px; background:#fafafa;"></textarea>
      </div>
      
      <div>
        <div class="column-title">‚≠ê No los sigo</div>
        <input type="text" class="search-input" placeholder="Buscar usuario..." onkeyup="filterList('iShouldFollowLinks', this.value)">
        <div id="iShouldFollowLinks" class="scroll-area"></div>
      </div>
    </div>
  </div>
</div>

<script>
// Registro del Service Worker corregido
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/Insta-Track/sw.js').then(function(reg) {
      console.log('SW OK!', reg.scope);
    }).catch(function(err) {
      console.log('SW Error:', err);
    });
  });
}

window.onload = () => {
  const saved = localStorage.getItem('insta_ghost_list');
  if (saved) document.getElementById('ghostList').value = saved;
};

function saveGhosts() { localStorage.setItem('insta_ghost_list', document.getElementById('ghostList').value); }
function toggleGhost() { document.getElementById('ghostManager').classList.toggle('hidden'); }
function markLoaded(id) { document.getElementById(id).classList.add('loaded'); }

function filterList(containerId, query) {
  const items = document.getElementById(containerId).getElementsByClassName('user-row');
  const q = query.toLowerCase();
  for (let item of items) {
    item.style.display = item.textContent.toLowerCase().includes(q) ? 'flex' : 'none';
  }
}

async function extract(file) {
  const text = await file.text();
  const found = new Set();
  const regex = /(?:(?<=>)|(?<="value":\s*")|(?<=\/_u\/)|(?<=\.com\/))([a-z0-9._]{2,30})(?=[<"]|\/|$)/gi;
  const userGhosts = document.getElementById('ghostList').value.toLowerCase().split('\n').map(s => s.trim()).filter(s => s);
  const blacklist = ['_u', 'u', 'siguiendo', 'seguidores', 'mensaje', 'explore', 'reels', 'true', 'false', ...userGhosts];
  let m;
  while ((m = regex.exec(text)) !== null) {
    const user = m[1].toLowerCase();
    if (!blacklist.includes(user) && !/^\d+$/.test(user) && user.length > 2) found.add(user);
  }
  return Array.from(found);
}

document.getElementById('processBtn').onclick = async () => {
  const f1 = document.getElementById('fileFollowing').files[0];
  const f2 = document.getElementById('fileFollowers').files[0];
  if (!f1 || !f2) return alert("Selecciona ambos archivos.");

  const following = await extract(f1);
  const followers = await extract(f2);
  const setFollowing = new Set(following);
  const setFollowers = new Set(followers);

  renderList('notFollowingLinks', following.filter(u => !setFollowers.has(u)).sort());
  renderList('iShouldFollowLinks', followers.filter(u => !setFollowing.has(u)).sort());
  
  document.getElementById('mutuals').value = following.filter(u => setFollowers.has(u)).sort().join('\n');
  document.getElementById('countFollowing').textContent = following.length;
  document.getElementById('countFollowers').textContent = followers.length;
  document.getElementById('countNotFollowing').textContent = following.filter(u => !setFollowers.has(u)).length;
  document.getElementById('countIShouldFollow').textContent = followers.filter(u => !setFollowing.has(u)).length;
  document.getElementById('results').classList.remove('hidden');
};

function renderList(id, users) {
  const container = document.getElementById(id);
  container.innerHTML = '';
  users.forEach((u, index) => {
    const itemId = `row-${id}-${index}`;
    const div = document.createElement('div');
    div.className = 'user-row';
    div.id = itemId;
    div.innerHTML = `
      <a href="https://www.instagram.com/${u}/" target="_blank" class="user-tag">@${u}</a>
      <button class="btn-ghost" onclick="addToGhost('${u}', '${itemId}')">üëª</button>
    `;
    container.appendChild(div);
  });
}

function addToGhost(user, elementId) {
  let list = document.getElementById('ghostList');
  list.value += (list.value ? '\n' : '') + user;
  saveGhosts();
  document.getElementById(elementId).style.display = 'none';
  let counter = document.getElementById('countNotFollowing');
  counter.textContent = parseInt(counter.textContent) - 1;
}

function copyToClipboard(id) {
  navigator.clipboard.writeText(document.getElementById(id).value);
  alert("Copiado");
}

function downloadGhosts() {
  const blob = new Blob([document.getElementById('ghostList').value], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'fantasmas.txt';
  a.click();
}

async function importGhosts(input) {
  document.getElementById('ghostList').value = await input.files[0].text();
  saveGhosts();
  alert("Importado");
}
</script>
</body>
</html>
