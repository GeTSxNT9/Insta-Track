<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
<title>INSTA TRACK</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="icon" href="https://api.dicebear.com/7.x/initials/svg?seed=I&backgroundColor=000000&textColor=ffffff&fontSize=60&fontWeight=700">
<link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/initials/svg?seed=I&backgroundColor=000000&textColor=ffffff&fontSize=60&fontWeight=700">

<style>
  :root {
    --bg: #f0f2f5; --card: #ffffff; --border: #dce2e8; --accent: #0095f6;
    --success: #00ba69; --text: #1c1e21; --muted: #65676b; --radius: 16px;
    --danger: #f4212e;
  }
  
  body { background: var(--bg); margin:0; padding:10px; display:flex; justify-content:center; color: var(--text); font-family: -apple-system, system-ui, sans-serif; }
  .container { max-width: 1000px; width: 100%; background: var(--card); border-radius: var(--radius); padding:20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-top: 10px; }
  
  header { text-align: center; margin-bottom: 25px; }
  h1 { margin: 0; font-size: 26px; letter-spacing: -1px; font-weight: 800; text-transform: uppercase; }

  /* Grid de Carga Mejorado */
  .grid-upload { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:20px; margin-bottom: 30px; }
  
  .file-box { 
    background: #f8fafc; 
    padding: 35px 20px; 
    border-radius: var(--radius); 
    border: 2px dashed var(--border); 
    transition: all 0.3s ease; 
    text-align: center; 
    cursor: pointer;
    position: relative;
  }

  .file-box:hover { border-color: var(--accent); background: #f0f9ff; transform: translateY(-2px); }

  /* Iconos din√°micos mediante CSS */
  .file-box::before {
    content: 'üìÅ';
    display: block;
    font-size: 32px;
    margin-bottom: 12px;
    filter: grayscale(1);
    opacity: 0.5;
    transition: 0.3s;
  }

  .file-box label { display: block; margin-bottom: 10px; font-weight: 900; font-size: 15px; color: var(--text); text-transform: uppercase; letter-spacing: 1.5px; pointer-events: none; }
  
  .file-info { font-size: 11px; color: var(--muted); font-weight: 600; }

  /* Estado Cargado */
  .file-box.loaded { border-color: var(--success); background: #f0fdf4; border-style: solid; }
  .file-box.loaded::before { content: '‚úÖ'; filter: grayscale(0); opacity: 1; }
  .file-box.loaded label { color: var(--success); }
  .file-box.loaded .file-info { color: var(--success); opacity: 0.8; }
  
  .main-actions { display:flex; gap:10px; margin-bottom: 30px; flex-wrap: wrap; }
  button { padding:12px 18px; border-radius:12px; border:none; cursor:pointer; font-weight:600; font-size: 14px; transition: 0.2s; display: flex; align-items: center; gap: 8px; justify-content: center; }
  .btn-primary { background: var(--accent); color:#fff; flex: 2; min-width: 150px; }
  .btn-outline { background: #fff; border: 1px solid var(--border); color: var(--text); flex: 1; }
  .btn-danger { background: #fff1f2; color: var(--danger); flex: 1; }

  .stats-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; margin-bottom: 25px; }
  .stat-card { background: #fff; padding:15px; border-radius:var(--radius); text-align:center; border: 1px solid var(--border); }
  .stat-card span { font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 700; display: block; margin-bottom: 5px; }
  .stat-card strong { font-size: 24px; color: var(--text); }
  
  .grid-lists { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px; }
  .column-title { margin-bottom: 12px; font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 8px; }
  .search-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border); border-radius: 12px; font-size: 14px; box-sizing: border-box; outline: none; transition: 0.2s; }
  .scroll-area { height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius); padding: 8px; background: #fafafa; }
  .user-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .user-tag { flex-grow: 1; padding: 10px 14px; background: #fff; color: var(--text); text-decoration: none; border-radius: 12px; font-size: 13px; border: 1px solid var(--border); font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .btn-ghost { padding: 10px; background: #fff; color: #adb5bd; border: 1px solid var(--border); border-radius: 10px; cursor: pointer; }
  textarea { width:100%; height:120px; padding:12px; border-radius:12px; border: 1px solid var(--border); font-size: 12px; margin-bottom: 10px; box-sizing: border-box; resize: none; outline: none; }
  .hidden { display:none !important; }
  .panel-ghost { margin-bottom: 25px; padding: 18px; background: #fff; border: 1px solid var(--border); border-radius: var(--radius); border-left: 4px solid var(--danger); }
  #saveIndicator { position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; display: none; z-index: 1000; }
</style>
</head>
<body>

<div id="saveIndicator">Guardado ‚úì</div>

<div class="container">
  <header>
    <h1>INSTA TRACK</h1>
  </header>
  
  <div class="grid-upload">
    <div class="file-box" id="boxFollowing" onclick="document.getElementById('fileFollowing').click()">
      <label>FOLLOWING</label>
      <span class="file-info" id="infoFollowing">Toca para seleccionar archivo</span>
      <input id="fileFollowing" type="file" onchange="markLoaded('boxFollowing')" accept=".json,.html" style="display:none">
    </div>

    <div class="file-box" id="boxFollowers" onclick="document.getElementById('fileFollowers').click()">
      <label>FOLLOWERS</label>
      <span class="file-info" id="infoFollowers">Toca para seleccionar archivo</span>
      <input id="fileFollowers" type="file" onchange="markLoaded('boxFollowers')" accept=".json,.html" style="display:none">
    </div>
  </div>

  <div class="main-actions">
    <button id="processBtn" class="btn-primary">üìä ANALIZAR AHORA</button>
    <button onclick="location.reload()" class="btn-outline">üßπ LIMPIAR</button>
    <button onclick="toggleGhost()" class="btn-danger">üëª FILTROS</button>
  </div>

  <div id="ghostManager" class="panel-ghost hidden">
    <h3 style="margin-top:0; font-size: 15px; color: var(--danger);">Gesti√≥n de Excepciones</h3>
    <textarea id="ghostList" oninput="saveGhosts()" placeholder="Usuarios ignorados..."></textarea>
  </div>

  <div class="results hidden" id="results">
    <div class="stats-grid">
      <div class="stat-card"><span>Sigo</span><strong id="countFollowing">0</strong></div>
      <div class="stat-card"><span>Seguidores</span><strong id="countFollowers">0</strong></div>
      <div class="stat-card" style="background: #fff1f2;"><span>No me siguen</span><strong id="countNotFollowing" style="color: var(--danger);">0</strong></div>
      <div class="stat-card" style="background: #f0fdf4;"><span>No los sigo</span><strong id="countIShouldFollow" style="color: var(--success);">0</strong></div>
    </div>

    <div class="grid-lists">
      <div>
        <div class="column-title">üö´ No me siguen</div>
        <input type="text" class="search-input" placeholder="Filtrar..." onkeyup="filterList('notFollowingLinks', this.value)">
        <div id="notFollowingLinks" class="scroll-area"></div>
      </div>
      
      <div>
        <div class="column-title">ü§ù Seguimiento mutuo</div>
        <textarea id="mutuals" readonly style="height:398px; background:#f8f9fa; color: var(--muted);"></textarea>
      </div>
      
      <div>
        <div class="column-title">‚≠ê Fans (No los sigo)</div>
        <input type="text" class="search-input" placeholder="Filtrar..." onkeyup="filterList('iShouldFollowLinks', this.value)">
        <div id="iShouldFollowLinks" class="scroll-area"></div>
      </div>
    </div>
  </div>
</div>

<script>
// Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    const swPath = window.location.pathname.includes('/Insta-Track/') ? '/Insta-Track/sw.js' : 'sw.js';
    navigator.serviceWorker.register(swPath).catch(err => console.log('Error SW:', err));
  });
}

// markLoaded mejorado para mostrar el nombre del archivo
function markLoaded(id) { 
  const box = document.getElementById(id);
  box.classList.add('loaded'); 
  const input = box.querySelector('input');
  const info = box.querySelector('.file-info');
  if (input.files.length > 0) {
    info.textContent = input.files[0].name;
  }
}

window.onload = () => {
  const saved = localStorage.getItem('insta_ghost_list');
  if (saved) document.getElementById('ghostList').value = saved;
};

function saveGhosts() { 
  localStorage.setItem('insta_ghost_list', document.getElementById('ghostList').value); 
  showIndicator();
}

function showIndicator() {
  const ind = document.getElementById('saveIndicator');
  ind.style.display = 'block';
  setTimeout(() => ind.style.display = 'none', 1500);
}

function toggleGhost() { document.getElementById('ghostManager').classList.toggle('hidden'); }

function filterList(containerId, query) {
  const items = document.getElementById(containerId).getElementsByClassName('user-row');
  const q = query.toLowerCase();
  for (let item of items) {
    item.style.display = item.textContent.toLowerCase().includes(q) ? 'flex' : 'none';
  }
}

async function extract(file) {
  const text = await file.text();
  const found = new Set();
  const regex = /(?:(?<=>)|(?<="value":\s*")|(?<=\/_u\/)|(?<=\.com\/))([a-z0-9._]{2,30})(?=[<"]|\/|$)/gi;
  const userGhosts = document.getElementById('ghostList').value.toLowerCase().split('\n').map(s => s.trim()).filter(s => s);
  const blacklist = ['_u', 'u', 'siguiendo', 'seguidores', 'mensaje', 'explore', 'reels', 'true', 'false', 'direct', ...userGhosts];
  
  let m;
  while ((m = regex.exec(text)) !== null) {
    const user = m[1].toLowerCase();
    if (!blacklist.includes(user) && !/^\d+$/.test(user) && user.length > 2) {
      found.add(user);
    }
  }
  return Array.from(found);
}

document.getElementById('processBtn').onclick = async () => {
  const f1 = document.getElementById('fileFollowing').files[0];
  const f2 = document.getElementById('fileFollowers').files[0];
  if (!f1 || !f2) return alert("Selecciona ambos archivos.");

  document.getElementById('processBtn').textContent = "üîÑ Procesando...";
  
  try {
    const following = await extract(f1);
    const followers = await extract(f2);
    const setFollowing = new Set(following);
    const setFollowers = new Set(followers);

    renderList('notFollowingLinks', following.filter(u => !setFollowers.has(u)).sort());
    renderList('iShouldFollowLinks', followers.filter(u => !setFollowing.has(u)).sort());
    
    document.getElementById('mutuals').value = following.filter(u => setFollowers.has(u)).sort().join('\n');
    document.getElementById('countFollowing').textContent = following.length;
    document.getElementById('countFollowers').textContent = followers.length;
    document.getElementById('countNotFollowing').textContent = following.filter(u => !setFollowers.has(u)).length;
    document.getElementById('countIShouldFollow').textContent = followers.filter(u => !setFollowing.has(u)).length;
    
    document.getElementById('results').classList.remove('hidden');
    document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
  } catch (err) {
    alert("Error al procesar.");
  } finally {
    document.getElementById('processBtn').textContent = "üìä ANALIZAR AHORA";
  }
};

function renderList(id, users) {
  const container = document.getElementById(id);
  container.innerHTML = '';
  users.forEach((u, index) => {
    const itemId = `row-${id}-${index}`;
    const div = document.createElement('div');
    div.className = 'user-row';
    div.id = itemId;
    div.innerHTML = `<a href="https://www.instagram.com/${u}/" target="_blank" class="user-tag">@${u}</a><button class="btn-ghost" onclick="addToGhost('${u}', '${itemId}')">üëª</button>`;
    container.appendChild(div);
  });
}

function addToGhost(user, elementId) {
  let list = document.getElementById('ghostList');
  list.value += (list.value ? '\n' : '') + user;
  saveGhosts();
  const el = document.getElementById(elementId);
  el.style.display = 'none';
}
</script>
</body>
</html>
